# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

KarotteControl is a Phoenix 1.8 + LiveView application for managing DigitalOcean resources (Apps, Databases, Container Registry). It uses PostgreSQL and includes user authentication via `phx.gen.auth`.

## Common Commands

```bash
mix setup              # Install deps, create DB, run migrations, setup assets
mix phx.server         # Start the Phoenix server (http://localhost:4000)
iex -S mix phx.server  # Start with IEx shell

mix test               # Run all tests
mix test path/to/test.exs           # Run specific test file
mix test path/to/test.exs:42        # Run test at specific line
mix test --failed                   # Re-run previously failed tests

mix precommit          # Run before committing: compile warnings, format, test
mix format             # Format all files
```

## Architecture

### Core Modules

- `KarotteControl.Accounts` - User authentication context (generated by `phx.gen.auth`)
- `KarotteControl.Accounts.Scope` - Scoped access pattern for multi-tenancy
- `KarotteControl.DigitalOcean.*` - DigitalOcean API integration:
  - `Client` - HTTP client wrapper using Req
  - `Apps`, `Databases`, `Registry` - Domain-specific API modules

### Web Layer

- `KarotteControlWeb.Router` - Routes organized by auth requirement:
  - Public routes use `:browser` pipeline
  - Auth-required routes add `:require_authenticated_user` plug
  - Registration routes add `:redirect_if_user_is_authenticated` plug
- `KarotteControlWeb.UserAuth` - Authentication plugs and helpers
- LiveViews in `lib/karotte_control_web/live/digital_ocean/` for DigitalOcean resource management

### Configuration

- Environment variables loaded via `dotenvy` - use `.env` file for local development
- `DIGITALOCEAN_API_TOKEN` required for DigitalOcean API access

## Key Conventions from AGENTS.md

### Phoenix 1.8 / LiveView

- Wrap LiveView templates with `<Layouts.app flash={@flash} current_scope={@current_scope}>`
- Use `@current_scope.user` to access current user (not `@current_user`)
- Use `<.icon name="hero-x-mark">` for icons, `<.input>` for form inputs
- Always use `to_form/2` with changesets, never pass changesets directly to templates
- Use LiveView streams for collections (not regular list assigns)

### Forms and Templates

- Use `{...}` interpolation in tag attributes, `<%= %>` only for block constructs in tag bodies
- Class conditionals must use list syntax: `class={["base", @flag && "conditional"]}`
- No `@apply` in CSS, no inline `<script>` tags

### Elixir/Ecto

- Use `Req` for HTTP requests (not HTTPoison, Tesla, or httpc)
- Use `Ecto.Changeset.get_field/2` to access changeset fields
- Don't use `String.to_atom/1` on user input
- Predicate functions end with `?` (not `is_` prefix)

### Authentication

- Always pass `current_scope` to context modules as first argument
- Place routes in correct scope based on auth requirements
- Use `@current_scope.user` in templates to access the logged-in user
